<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="赤条条来去无牵挂"><title>说出来你们可能不信，strptime竟然是非线程安全的 | 姑娘请站住</title><link rel="stylesheet" type="text/css" href="/css/normalize.css?v=lisnb-0.0.1"><link rel="stylesheet" type="text/css" href="/css/pure-min.css?v=lisnb-0.0.1"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css?v=lisnb-0.0.1"><link rel="stylesheet" type="text/css" href="/css/style.css?v=lisnb-0.0.1"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">说出来你们可能不信，strptime竟然是非线程安全的</h1><a id="logo" href="/.">姑娘请站住</a><p class="description">令人愉悦的忧伤</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="http://about.lixipeng.me/en"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">说出来你们可能不信，strptime竟然是非线程安全的</h1><div class="post-meta">Mar 12, 2016<span> | </span><span class="category"><a href="/categories/python/">python</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016-03/strptime-thread-not-safe/" href="/2016-03/strptime-thread-not-safe/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h3 id="事情是这样的"><a href="#事情是这样的" class="headerlink" title="事情是这样的"></a>事情是这样的</h3><p>今天在做实验的时候，用到了这样的一个函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter_updatetime</span><span class="params">(duration)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_filter_updatetime</span><span class="params">(news)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'updateTime'</span> <span class="keyword">in</span> news:</span><br><span class="line">            updateTime = datetime.strptime(news[<span class="string">'updateTime'</span>], <span class="string">'%Y/%m/%d %X'</span>)</span><br><span class="line">            now  = datetime.now()</span><br><span class="line">            <span class="keyword">return</span> abs((now-updateTime).total_seconds())&lt;duration</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logging.debug(<span class="string">'%s has no updateTime'</span>%news[<span class="string">'title'</span>])</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">return</span> _filter_updatetime</span><br></pre></td></tr></table></figure>
<p>是在多线程里用的，但执行的时候偶尔会遇到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AttributeError: &apos;module&apos; object has no attribute &apos;_strptime&apos;</span><br></pre></td></tr></table></figure></p>
<p>这样的错误，我一脸日了狗的表情，因为我曾多次遇到类似的这个错误，多是因为我比较粗心，忘记了<code>from datetime import datetime</code>而是直接用了<code>import datetime</code>，然而这次我并没有犯这种低级的错误，然后我发现这次说找不到的属性是<code>_strptime</code>而不是<code>strptime</code>，我心说大事不好！</p>
<p>我一开始没有想到是线程的问题，但查的时候发现为数不多的结果里都说是在多线程的时候才会出现这个问题，就又加了多线程来查，最后发现是因为线程安全的问题。</p>
<h3 id="问题重现"><a href="#问题重现" class="headerlink" title="问题重现"></a>问题重现</h3><ul>
<li><strong>Windows</strong>: Python 2.7.8 |Anaconda 2.1.0 (64-bit) | (default, Jul 2 2014, 15:12:11) [MSC v.1500 64 bit (AMD64)]</li>
<li><strong>OS X</strong>: Python 2.7.6 (default, Sep  9 2014, 15:04:36) </li>
</ul>
<p>都会出现这个问题，使用下面简单的代码就可以重现：</p>
<figure class="highlight python"><figcaption><span>issue7980.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">        threading.Thread(target = datetime.strptime, args=(<span class="string">'2016/03/12 10:59:07'</span>, <span class="string">'%Y/%m/%d %X'</span>)).start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>
<p>错误信息（OS X）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread Thread-2:</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/threading.py&quot;, line 810, in __bootstrap_inner</span><br><span class="line">    self.run()</span><br><span class="line">  File &quot;/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/threading.py&quot;, line 763, in run</span><br><span class="line">    self.__target(*self.__args, **self.__kwargs)</span><br><span class="line">AttributeError: _strptime</span><br></pre></td></tr></table></figure>
<h3 id="问题出在"><a href="#问题出在" class="headerlink" title="问题出在"></a>问题出在</h3><p><a href="http://bugs.python.org/issue7980" target="_blank" rel="external">issue7980</a>中对这个问题是这么解释的：</p>
<blockquote>
<p>Thread safety: The use of strptime is thread safe, but with one important caveat.  The first use of strptime is not thread safe because the first use will import _strptime.  That import is not thread safe and may throw AttributeError or ImportError.  To avoid this issue, import _strptime explicitly before starting threads, or call strptime once before starting threads.</p>
</blockquote>
<p>实际上strptime本身是线程安全的，但是需要注意的是，第一次用这个函数的时候不是线程安全的，因为第一次使用这个函数的时候，会import _strptime，这个导入的过程不是线程安全的，在这个过程可能会抛出异常或者导入错误。<br>如果想要避免这个问题，那就<strong>在线程启动之前，调用一次这个函数</strong>，使导入过程不发生在子线程中就好</p>
</div><a data-url="http://lixipeng.me/2016-03/strptime-thread-not-safe/" data-id="cilp9o6dc0018of5uaild0ojg" class="article-share-link">分享到</a><div class="tags"><a href="/tags/strptime/">strptime</a><a href="/tags/线程/">线程</a></div><div class="post-nav"><a href="/2014-12/stdiosrdbuf/" class="next">std::ios::rdbuf</a></div><div id="disqus_thread"><script>var disqus_shortname = 'lisnb';
var disqus_identifier = '2016-03/strptime-thread-not-safe/';
var disqus_title = '说出来你们可能不信，strptime竟然是非线程安全的';
var disqus_url = 'http://lixipeng.me/2016-03/strptime-thread-not-safe/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//lisnb.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C/">C++</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/C/Linux/">Linux</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/fullstack/">fullstack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/C/">C++</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/">mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/python/js/">js</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/碎碎碎碎念/">碎碎碎碎念</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/gprof2dot/" style="font-size: 15px;">gprof2dot</a> <a href="/tags/老罗/" style="font-size: 15px;">老罗</a> <a href="/tags/T1/" style="font-size: 15px;">T1</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/js/" style="font-size: 15px;">js</a> <a href="/tags/bubble/" style="font-size: 15px;">bubble</a> <a href="/tags/汉字点阵/" style="font-size: 15px;">汉字点阵</a> <a href="/tags/chrome-extension/" style="font-size: 15px;">chrome extension</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/valgrind/" style="font-size: 15px;">valgrind</a> <a href="/tags/callgrind/" style="font-size: 15px;">callgrind</a> <a href="/tags/smartisan/" style="font-size: 15px;">smartisan</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/gdb/" style="font-size: 15px;">gdb</a> <a href="/tags/coredumped/" style="font-size: 15px;">coredumped</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/svn/" style="font-size: 15px;">svn</a> <a href="/tags/罗永浩/" style="font-size: 15px;">罗永浩</a> <a href="/tags/rdbuf/" style="font-size: 15px;">rdbuf</a> <a href="/tags/c/" style="font-size: 15px;">c++</a> <a href="/tags/io/" style="font-size: 15px;">io</a> <a href="/tags/strptime/" style="font-size: 15px;">strptime</a> <a href="/tags/线程/" style="font-size: 15px;">线程</a> <a href="/tags/mac/" style="font-size: 15px;">mac</a> <a href="/tags/文件共享/" style="font-size: 15px;">文件共享</a> <a href="/tags/共享账户/" style="font-size: 15px;">共享账户</a> <a href="/tags/内存泄漏/" style="font-size: 15px;">内存泄漏</a> <a href="/tags/memory-leak/" style="font-size: 15px;">memory leak</a> <a href="/tags/memcheck/" style="font-size: 15px;">memcheck</a> <a href="/tags/招远/" style="font-size: 15px;">招远</a> <a href="/tags/南开大学/" style="font-size: 15px;">南开大学</a> <a href="/tags/小浣熊/" style="font-size: 15px;">小浣熊</a> <a href="/tags/傻老娘们儿/" style="font-size: 15px;">傻老娘们儿</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016-03/strptime-thread-not-safe/">说出来你们可能不信，strptime竟然是非线程安全的</a></li><li class="post-list-item"><a class="post-list-link" href="/2014-12/stdiosrdbuf/">std::ios::rdbuf</a></li><li class="post-list-item"><a class="post-list-link" href="/2014-11/intro-to-git/">Git 使用简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2014-11/cpp-performance/">Linux下C++性能分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2014-10/mac-file-share/">mac与windows间文件共享和账户设置</a></li><li class="post-list-item"><a class="post-list-link" href="/2014-10/memory-leak/">Linux下C++内存泄漏检测</a></li><li class="post-list-item"><a class="post-list-link" href="/2014-10/malaoluo/">你要成功，这很重要</a></li><li class="post-list-item"><a class="post-list-link" href="/2014-09/xiangnian/">享年</a></li><li class="post-list-item"><a class="post-list-link" href="/2014-09/chrome-extension-noweibo/">(chrome extension) noweibo</a></li><li class="post-list-item"><a class="post-list-link" href="/2014-08/xiaoqiujunan/">倒也谈不上天理难容</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//lisnb.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">姑娘请站住.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/lisnb"> Follow</a> me on Github.</div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/jquery.min.js?v=lisnb-0.0.1"></script><script type="text/javascript" src="/js/totop.js?v=lisnb-0.0.1"></script><script type="text/javascript" src="/js/fancybox.pack.js?v=lisnb-0.0.1"></script><script type="text/javascript" src="/js/jquery.fancybox.js?v=lisnb-0.0.1"></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=lisnb-0.0.1"><script type="text/javascript" src="/js/share.js?v=lisnb-0.0.1"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=lisnb-0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=lisnb-0.0.1"></script></div></body></html>