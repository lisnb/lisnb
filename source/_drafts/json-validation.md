---
title: 一种在C++中进行JSON字段校验的方法[1]
date: 2017-04-17 21:47:38
categories: C++
tags: 
- json
- validation
---

如果一个服务器是以JSON这种形式来返回结果，那在某些情况，我们希望在返回前对结果进行校验，确定某些重要的字段在合法的范围或者符合其他的一些什么条件（而并不是校验这个JSON字符串是不是符合JSON的语法规则，比如少了一个引号等），本文会介绍一种使用C++实现的对JSON字段进行校验的方法。本文基于 [jsoncpp](https://github.com/open-source-parsers/jsoncpp) 来实现。

<!--more-->

### 例子

作为例子，假设服务器返回的结果是如下的结构：

```json
{
  "charlie": -1,
  "delta": 4.2,
  "foxtrot": false,
  "golf": {
    "hotel": "india",
    "july": ["kilo", "lima", "mike"],
    "november": {
      "oscar": {
        "papa": null
      }
    }
  }
}
```

上述结构基本涵盖了JSON能够表达的所有类型：整数、浮点、布尔、字符串、数组、null和键值的嵌套，也就是对象。
假设我们对最后的结果的要求是这样的：

- ```charlie``` 大于1且小于10
- ```delta``` 是浮点型或者等于0.0
- ```"mike"``` 在 ```july``` 中


### 为么要校验JSON

如果服务端是使用 node 或者 python 这种弱类型的语言，这个结果可能是由一个 Object 或者是一个 dict 序列化出来的，但是因为 C++ 是强类型语言，所以服务端在返回这个结果时，大多数都是通过将一个类（假设这个类叫做 Bravo）的实例（bravo）的成员一个一个的赋值给一个 JsonValue 的实例（json\_bravo)，再序列化这个json\_bravo来完成。如果最终的返回结果非法，那有两种可能：1、本来bravo中的数据就是错的，bravo.charlie应该大于0；2、在将bravo.charlie写到json\_bravo的时候，调用了to\_string方法，把一个整形变量写成了字符串。返回的JSON结果中，如果出现了变量类型不对的情况，基本上都是由于上述的第二种原因导致的。这也是为什么在做返回结果的校验时，校验json\_bravo，而不是bravo，因为 jsoncpp 对 JsonValue 的序列化过程我们认为是可靠的（当然有时也是不可靠的，后面会详细说明）。

### 校验器要考虑的问题

要做好校验工作，校验器至少需要实现以下功能：

1. 检查某个字段是否存在；
2. 检查某个字段是否符合某些条件，如：
  - 是否是特定的类型，如：布尔，整形等；
  - 是否在某个特定范围内
  - 是否满足其他特定的需要
3. 能够处理嵌套，比如检查例子中 ```papa``` 这个字段


达到以上目的，那算是基本完成了任务，实现起来并不难，但在这个基础上，我们不禁会想，可不可以提供一些更贴心的功能，比如：

1. 多个条件之间的布尔运算；
2. 修改校验条件的时候可以不修改代码；
3. 在写UT时可以非常简单；
4. 不要重载（因为需要判断不同类型的数据）和继承等等复杂的编码；

那一个什么样的校验器能够满足这些诉求呢？